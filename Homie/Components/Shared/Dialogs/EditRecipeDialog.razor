@namespace Homie.Components.Shared

@inject IDbService DbService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" Spacing="3">
            <MudTextField @bind-Value="Recipe.Title" Label="Title" Required/>
            <MultiSelectAutoComplete @bind-SelectedItems="_ingredients" SearchFunc="SearchIngredients" FromStringFunc="IngredientFromString" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Dialog.Cancel">Cancel</MudButton>
        <MudButton OnClick="OnUpdateItem" Color="Color.Primary" Variant="Variant.Filled">Update Recipe</MudButton>
    </DialogActions>
</MudDialog>


@code {

    [CascadingParameter]
    private IMudDialogInstance Dialog { get; set; }
    
    [Parameter, EditorRequired]
    public required Groceries.Recipe Recipe { get; set; }
    
    private HashSet<Groceries.Ingredient> _ingredients = new();

    private MudForm _form;

    protected override async Task OnInitializedAsync()
    {
        if (Recipe.Id == Guid.Empty)
            Dialog.Cancel();

        _ingredients = (await DbService.GetIngredientsByRecipeIdAsync(Recipe.Id)).ToHashSet();
    }

    private async Task OnUpdateItem()
    {
        await _form.Validate();
        if (!_form.IsValid) return;

        try
        {
            await DbService.UpdateRecipeAsync(Recipe, _ingredients);
            Snackbar.Add($"{Recipe} was updated", Severity.Success);
            Dialog.Close(DialogResult.Ok(true));
        }
        catch (Exception e)
        {
            Snackbar.Add($"{Recipe}) could not be updated", Severity.Error);
        }
    }

    
    private async Task<IEnumerable<Groceries.Ingredient>> SearchIngredients(string? query, CancellationToken cancellationToken)
    {
        var results = await DbService.SearchIngredientsAsync(query ?? string.Empty, cancellationToken: cancellationToken);
        return results.Except(_ingredients);
    }

    private Groceries.Ingredient IngredientFromString(string query) => new()
    {
        Title = query
    };
}